<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS - Pan y Atoles</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .nav-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .btn-primary { background: linear-gradient(45deg, #4CAF50, #45a049); color: white; }
        .btn-secondary { background: linear-gradient(45deg, #2196F3, #1976D2); color: white; }
        .btn-warning { background: linear-gradient(45deg, #FF9800, #F57C00); color: white; }
        .btn-danger { background: linear-gradient(45deg, #f44336, #d32f2f); color: white; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .section.active { display: block; }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .productos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .producto-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .producto-card:hover {
            transform: translateY(-5px);
            border-color: #667eea;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .producto-img {
            width: 100%;
            height: 150px;
            border-radius: 8px;
            margin-bottom: 10px;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
            font-size: 2rem;
            overflow: hidden;
        }

        .producto-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .producto-info h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .precio {
            font-size: 1.2rem;
            font-weight: bold;
            color: #4CAF50;
        }

        .stock {
            font-size: 0.9rem;
            color: #666;
        }

        .stock.agotado {
            color: #f44336;
            font-weight: bold;
        }

        .venta-actual {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .item-venta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .item-venta:last-child {
            border-bottom: none;
            font-weight: bold;
            font-size: 1.2rem;
            color: #4CAF50;
        }

        .clientes-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .cliente-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }

        .cliente-item.con-deuda {
            border-left-color: #f44336;
        }

        .deuda-amount {
            color: #f44336;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover { color: #000; }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .hidden { display: none !important; }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .nav-buttons { grid-template-columns: 1fr 1fr; }
            .productos-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üçûü•§ POS Pan y Atoles</h1>
            <p>Sistema de Punto de Venta</p>
        </div>

        <div class="nav-buttons">
            <button class="btn btn-primary" onclick="mostrarSeccion('productos')">üì¶ Productos</button>
            <button class="btn btn-secondary" onclick="mostrarSeccion('venta')">üõí Venta</button>
            <button class="btn btn-warning" onclick="mostrarSeccion('clientes')">üë• Clientes</button>
            <button class="btn btn-danger" onclick="mostrarSeccion('reportes')">üìä Reportes</button>
            <button class="btn btn-primary" onclick="mostrarSeccion('configuracion')">‚öôÔ∏è Config</button>
        </div>

        <!-- Alertas -->
        <div id="alertas"></div>

        <!-- Secci√≥n de Productos -->
        <div id="productos" class="section active">
            <h2>üì¶ Productos del D√≠a</h2>
            
            <div class="form-group">
                <button class="btn btn-primary" onclick="mostrarAgregarProducto()">‚ûï Agregar Producto</button>
                <button class="btn btn-danger" onclick="limpiarInventario()">üóëÔ∏è Limpiar Inventario</button>
            </div>

            <div id="productos-hoy" class="productos-grid">
            </div>
        </div>

        <!-- Secci√≥n de Venta -->
        <div id="venta" class="section">
            <h2>üõí Nueva Venta</h2>
            
            <div class="form-group">
                <h3>Productos Disponibles:</h3>
                <div id="productos-venta" class="productos-grid">
                </div>
            </div>

            <div class="venta-actual">
                <h3>üßæ Venta Actual:</h3>
                <div id="items-venta">
                    <div class="item-venta">
                        <span>Carrito vac√≠o</span>
                        <span>$0.00</span>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <button class="btn btn-primary" onclick="procesarVenta()">üí∞ Procesar Venta</button>
                <button class="btn btn-danger" onclick="cancelarVenta()">‚ùå Cancelar</button>
            </div>
        </div>

        <!-- Secci√≥n de Clientes -->
        <div id="clientes" class="section">
            <h2>üë• Gesti√≥n de Clientes</h2>
            
            <div class="form-group">
                <button class="btn btn-primary" onclick="mostrarTodosClientes()">üìá Todos</button>
                <button class="btn btn-warning" onclick="mostrarClientesDeuda()">üí≥ Con Deuda</button>
                <button class="btn btn-secondary" onclick="abrirPagoDeuda()">üí∞ Cobrar</button>
            </div>

            <div id="lista-clientes" class="clientes-list">
            </div>
        </div>

        <!-- Secci√≥n de Reportes -->
        <div id="reportes" class="section">
            <h2>üìä Reportes</h2>
            
            <div class="stats-grid" id="estadisticas-generales">
            </div>

            <div class="form-group">
                <button class="btn btn-primary" onclick="mostrarReporteVentas()">üìà Ventas</button>
                <button class="btn btn-secondary" onclick="mostrarReporteFinanciero()">üí∞ Financiero</button>
            </div>

            <div id="contenido-reportes">
            </div>
        </div>

        <!-- Configuraci√≥n -->
        <div id="configuracion" class="section">
            <h2>‚öôÔ∏è Configuraci√≥n</h2>
            
            <div class="form-group">
                <button class="btn btn-primary" onclick="nuevoDia()">üÜï Nuevo D√≠a</button>
                <button class="btn btn-warning" onclick="exportarDatos()">üíæ Exportar</button>
                <button class="btn btn-danger" onclick="resetearTodo()">üóëÔ∏è Reset</button>
            </div>

            <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px;">
                <strong>‚ö†Ô∏è Nuevo D√≠a:</strong> Solo limpia inventario. Clientes y ventas se mantienen.
            </div>
        </div>
    </div>

    <!-- Modal Producto -->
    <div id="modalProducto" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('modalProducto')">&times;</span>
            <h3>üì¶ Agregar Producto</h3>
            
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="nombreProducto" placeholder="Pan dulce, Atole chocolate">
            </div>
            
            <div class="form-group">
                <label>Categor√≠a:</label>
                <select id="categoriaProducto">
                    <option value="pan">üçû Pan</option>
                    <option value="atole">ü•§ Atole</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Precio:</label>
                <input type="number" id="precioProducto" step="0.50" placeholder="15.00">
            </div>
            
            <div class="form-group">
                <label>Cantidad:</label>
                <input type="number" id="cantidadProducto" placeholder="20">
            </div>

            <div style="text-align: center; margin: 20px 0;">
                <button class="btn btn-secondary" onclick="activarCamara()">üì∑ Tomar Foto</button>
                <video id="camera" width="300" height="200" style="display:none; border-radius: 10px; margin: 10px 0;"></video>
                <canvas id="canvas" width="300" height="200" style="display:none;"></canvas>
                <div id="preview-foto"></div>
            </div>
            
            <div class="form-group">
                <button class="btn btn-primary" onclick="guardarProducto()">‚úÖ Guardar</button>
                <button class="btn btn-secondary" onclick="cerrarModal('modalProducto')">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Pago -->
    <div id="modalPago" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('modalPago')">&times;</span>
            <h3>üí∞ Procesar Pago</h3>
            
            <div id="resumen-venta"></div>
            
            <div class="form-group">
                <label>Tipo de Pago:</label>
                <select id="tipoPago" onchange="cambiarTipoPago()">
                    <option value="contado">üíµ Contado</option>
                    <option value="fiado">üí≥ Fiado</option>
                </select>
            </div>

            <div id="datos-cliente" class="form-group hidden">
                <label>Cliente:</label>
                <input type="text" id="nombreCliente" placeholder="Nombre del cliente">
                
                <label>Tel√©fono:</label>
                <input type="text" id="telefonoCliente" placeholder="Opcional">
                
                <label>Referencia:</label>
                <input type="text" id="referenciaVenta" placeholder="Casa azul, trabajo...">
            </div>
            
            <div class="form-group">
                <button class="btn btn-primary" onclick="confirmarVenta()">‚úÖ Confirmar</button>
                <button class="btn btn-secondary" onclick="cerrarModal('modalPago')">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Modal Pago Deuda -->
    <div id="modalPagoDeuda" class="modal">
        <div class="modal-content">
            <span class="close" onclick="cerrarModal('modalPagoDeuda')">&times;</span>
            <h3>üí∞ Cobrar Deuda</h3>
            <div id="contenido-pago-deuda"></div>
        </div>
    </div>

    <script>
        // Variables globales
        let productos = [];
        let clientes = [];
        let ventas = [];
        let pagosDeuda = [];
        let ventaActual = [];
        let camaraActiva = false;
        let fotoCapturada = null;

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            cargarDatos();
            actualizarVistaProductos();
            actualizarProductosVenta();
            actualizarEstadisticas();
        });

        // Gesti√≥n de datos
        function cargarDatos() {
            try {
                productos = JSON.parse(localStorage.getItem('productos_pan_atoles') || '[]');
                clientes = JSON.parse(localStorage.getItem('clientes_pan_atoles') || '[]');
                ventas = JSON.parse(localStorage.getItem('ventas_pan_atoles') || '[]');
                pagosDeuda = JSON.parse(localStorage.getItem('pagos_pan_atoles') || '[]');
            } catch (error) {
                mostrarAlerta('Error cargando datos', 'error');
            }
        }

        function guardarDatos() {
            try {
                localStorage.setItem('productos_pan_atoles', JSON.stringify(productos));
                localStorage.setItem('clientes_pan_atoles', JSON.stringify(clientes));
                localStorage.setItem('ventas_pan_atoles', JSON.stringify(ventas));
                localStorage.setItem('pagos_pan_atoles', JSON.stringify(pagosDeuda));
            } catch (error) {
                mostrarAlerta('Error guardando datos', 'error');
            }
        }

        // Utilidades
        function mostrarAlerta(mensaje, tipo = 'success') {
            const alertas = document.getElementById('alertas');
            const alerta = document.createElement('div');
            alerta.className = `alert alert-${tipo}`;
            alerta.textContent = mensaje;
            alertas.appendChild(alerta);
            setTimeout(() => alerta.remove(), 3000);
        }

        function generarId() {
            return Date.now().toString() + Math.random().toString(36).substr(2, 5);
        }

        // Navegaci√≥n
        function mostrarSeccion(seccionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(seccionId).classList.add('active');
            if (seccionId === 'reportes') actualizarEstadisticas();
        }

        function mostrarModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (camaraActiva) detenerCamara();
        }

        // Productos
        function mostrarAgregarProducto() {
            document.getElementById('nombreProducto').value = '';
            document.getElementById('precioProducto').value = '';
            document.getElementById('cantidadProducto').value = '';
            document.getElementById('preview-foto').innerHTML = '';
            fotoCapturada = null;
            mostrarModal('modalProducto');
        }

        function activarCamara() {
            const video = document.getElementById('camera');
            
            if (!camaraActiva) {
                navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                })
                .then(stream => {
                    video.srcObject = stream;
                    video.style.display = 'block';
                    video.play();
                    camaraActiva = true;
                })
                .catch(() => mostrarAlerta('No se pudo acceder a la c√°mara', 'error'));
            } else {
                capturarFoto();
            }
        }

        function capturarFoto() {
            const video = document.getElementById('camera');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(video, 0, 0, 300, 200);
            fotoCapturada = canvas.toDataURL('image/jpeg', 0.8);
            
            document.getElementById('preview-foto').innerHTML = 
                `<img src="${fotoCapturada}" style="width:300px;height:200px;object-fit:cover;border-radius:8px;">`;
            
            detenerCamara();
        }

        function detenerCamara() {
            const video = document.getElementById('camera');
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.style.display = 'none';
                camaraActiva = false;
            }
        }

        function guardarProducto() {
            const nombre = document.getElementById('nombreProducto').value.trim();
            const categoria = document.getElementById('categoriaProducto').value;
            const precio = parseFloat(document.getElementById('precioProducto').value);
            const cantidad = parseInt(document.getElementById('cantidadProducto').value);
            
            if (!nombre || !precio || !cantidad) {
                mostrarAlerta('Todos los campos son obligatorios', 'error');
                return;
            }
            
            productos.push({
                id: generarId(),
                nombre,
                categoria,
                precio,
                cantidadDisponible: cantidad,
                cantidadOriginal: cantidad,
                foto: fotoCapturada,
                fechaCreacion: new Date().toISOString()
            });
            
            guardarDatos();
            actualizarVistaProductos();
            actualizarProductosVenta();
            cerrarModal('modalProducto');
            mostrarAlerta(`"${nombre}" agregado`);
        }

        function actualizarVistaProductos() {
            const container = document.getElementById('productos-hoy');
            
            if (productos.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;font-style:italic;">No hay productos. ¬°Agrega tu inventario!</p>';
                return;
            }
            
            container.innerHTML = productos.map(p => `
                <div class="producto-card">
                    <div class="producto-img">
                        ${p.foto ? `<img src="${p.foto}">` : (p.categoria === 'pan' ? 'üçû' : 'ü•§')}
                    </div>
                    <div class="producto-info">
                        <h3>${p.nombre}</h3>
                        <p class="precio">$${p.precio}</p>
                        <p class="stock ${p.cantidadDisponible === 0 ? 'agotado' : ''}">
                            Stock: ${p.cantidadDisponible}/${p.cantidadOriginal}
                        </p>
                        <button class="btn btn-danger" onclick="eliminarProducto('${p.id}')" 
                                style="margin-top:10px;width:100%;font-size:0.9rem;">
                            üóëÔ∏è Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function eliminarProducto(id) {
            if (confirm('¬øEliminar producto?')) {
                productos = productos.filter(p => p.id !== id);
                guardarDatos();
                actualizarVistaProductos();
                actualizarProductosVenta();
                mostrarAlerta('Producto eliminado');
            }
        }

        function limpiarInventario() {
            if (confirm('¬øLimpiar todo el inventario?')) {
                productos = [];
                ventaActual = [];
                guardarDatos();
                actualizarVistaProductos();
                actualizarProductosVenta();
                mostrarAlerta('Inventario limpiado');
            }
        }

        // Ventas
        function actualizarProductosVenta() {
            const container = document.getElementById('productos-venta');
            const disponibles = productos.filter(p => p.cantidadDisponible > 0);
            
            if (disponibles.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;">No hay productos disponibles</p>';
            } else {
                container.innerHTML = disponibles.map(p => `
                    <div class="producto-card" onclick="agregarAVenta('${p.id}')">
                        <div class="producto-img">
                            ${p.foto ? `<img src="${p.foto}">` : (p.categoria === 'pan' ? 'üçû' : 'ü•§')}
                        </div>
                        <div class="producto-info">
                            <h3>${p.nombre}</h3>
                            <p class="precio">$${p.precio}</p>
                            <p class="stock">Disponible: ${p.cantidadDisponible}</p>
                        </div>
                    </div>
                `).join('');
            }
            
            actualizarVistaVentaActual();
        }

        function agregarAVenta(productId) {
            const producto = productos.find(p => p.id === productId);
            const cantidad = parseInt(prompt(`¬øCu√°ntos "${producto.nombre}"?`, '1'));
            
            if (!cantidad || cantidad <= 0) return;
            
            if (cantidad > producto.cantidadDisponible) {
                mostrarAlerta('Stock insuficiente', 'error');
                return;
            }
            
            const itemExistente = ventaActual.find(item => item.productoId === productId);
            
            if (itemExistente) {
                if (itemExistente.cantidad + cantidad <= producto.cantidadDisponible) {
                    itemExistente.cantidad += cantidad;
                    itemExistente.subtotal = itemExistente.cantidad * producto.precio;
                } else {
                    mostrarAlerta('Stock insuficiente', 'error');
                    return;
                }
            } else {
                ventaActual.push({
                    productoId: productId,
                    nombre: producto.nombre,
                    precio: producto.precio,
                    cantidad: cantidad,
                    subtotal: cantidad * producto.precio
                });
            }
            
            actualizarVistaVentaActual();
            mostrarAlerta(`${producto.nombre} x${cantidad} agregado`);
        }

        function actualizarVistaVentaActual() {
            const container = document.getElementById('items-venta');
            
            if (ventaActual.length === 0) {
                container.innerHTML = '<div class="item-venta"><span>Carrito vac√≠o</span><span>$0.00</span></div>';
                return;
            }
            
            const total = ventaActual.reduce((sum, item) => sum + item.subtotal, 0);
            
            container.innerHTML = ventaActual.map(item => `
                <div class="item-venta">
                    <span>${item.nombre} x${item.cantidad}</span>
                    <span>$${item.subtotal.toFixed(2)}</span>
                </div>
            `).join('') + `
                <div class="item-venta">
                    <span><strong>TOTAL</strong></span>
                    <span><strong>$${total.toFixed(2)}</strong></span>
                </div>
            `;
        }

        function procesarVenta() {
            if (ventaActual.length === 0) {
                mostrarAlerta('Carrito vac√≠o', 'error');
                return;
            }
            
            const total = ventaActual.reduce((sum, item) => sum + item.subtotal, 0);
            document.getElementById('resumen-venta').innerHTML = `
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                    <h4>Resumen de venta:</h4>
                    ${ventaActual.map(item => `
                        <div style="display:flex;justify-content:space-between;">
                            <span>${item.nombre} x${item.cantidad}</span>
                            <span>$${item.subtotal.toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <hr>
                    <div style="display:flex;justify-content:space-between;font-weight:bold;">
                        <span>TOTAL:</span>
                        <span>$${total.toFixed(2)}</span>
                    </div>
                </div>
            `;
            
            document.getElementById('tipoPago').value = 'contado';
            document.getElementById('datos-cliente').classList.add('hidden');
            mostrarModal('modalPago');
        }

        function cambiarTipoPago() {
            const tipo = document.getElementById('tipoPago').value;
            const datosCliente = document.getElementById('datos-cliente');
            
            if (tipo === 'fiado') {
                datosCliente.classList.remove('hidden');
            } else {
                datosCliente.classList.add('hidden');
            }
        }

        function confirmarVenta() {
            const tipoPago = document.getElementById('tipoPago').value;
            const total = ventaActual.reduce((sum, item) => sum + item.subtotal, 0);
            let cliente = null;
            
            if (tipoPago === 'fiado') {
                const nombreCliente = document.getElementById('nombreCliente').value.trim();
                if (!nombreCliente) {
                    mostrarAlerta('Nombre del cliente requerido para fiado', 'error');
                    return;
                }
                
                // Buscar cliente existente o crear nuevo
                cliente = clientes.find(c => c.nombre.toLowerCase() === nombreCliente.toLowerCase());
                if (!cliente) {
                    cliente = {
                        id: generarId(),
                        nombre: nombreCliente,
                        telefono: document.getElementById('telefonoCliente').value.trim(),
                        totalDeuda: 0,
                        fechaRegistro: new Date().toISOString()
                    };
                    clientes.push(cliente);
                }
                
                cliente.totalDeuda += total;
            }
            
            // Crear venta
            const venta = {
                id: generarId(),
                items: [...ventaActual],
                total: total,
                tipoPago: tipoPago,
                cliente: cliente,
                referencia: document.getElementById('referenciaVenta').value.trim(),
                pagada: tipoPago === 'contado',
                fecha: new Date().toISOString()
            };
            
            // Actualizar inventario
            ventaActual.forEach(item => {
                const producto = productos.find(p => p.id === item.productoId);
                if (producto) {
                    producto.cantidadDisponible -= item.cantidad;
                }
            });
            
            ventas.push(venta);
            guardarDatos();
            
            // Mostrar recibo
            mostrarRecibo(venta);
            
            // Limpiar venta
            ventaActual = [];
            actualizarProductosVenta();
            cerrarModal('modalPago');
            
            mostrarAlerta(`Venta ${tipoPago === 'fiado' ? 'fiada' : 'procesada'} exitosamente`);
        }

        function mostrarRecibo(venta) {
            const tipoIcon = venta.tipoPago === 'contado' ? 'üíµ' : 'üí≥';
            const clienteInfo = venta.cliente ? `\nCliente: ${venta.cliente.nombre}` : '';
            const referenciaInfo = venta.referencia ? `\nReferencia: ${venta.referencia}` : '';
            
            let recibo = `üßæ RECIBO DE VENTA\n`;
            recibo += `Pan y Atoles\n`;
            recibo += `========================\n`;
            recibo += `Fecha: ${new Date(venta.fecha).toLocaleString('es-MX')}\n`;
            recibo += `ID: ${venta.id}\n`;
            recibo += `Tipo: ${venta.tipoPago.toUpperCase()} ${tipoIcon}${clienteInfo}${referenciaInfo}\n`;
            recibo += `------------------------\n`;
            
            venta.items.forEach(item => {
                recibo += `${item.nombre}\n`;
                recibo += `  ${item.cantidad} x ${item.precio} = ${item.subtotal.toFixed(2)}\n`;
            });
            
            recibo += `------------------------\n`;
            recibo += `TOTAL: ${venta.total.toFixed(2)}\n`;
            
            if (venta.tipoPago === 'fiado') {
                recibo += `\nüí≥ VENTA A CR√âDITO\n`;
                recibo += `Deuda total: ${venta.cliente.totalDeuda.toFixed(2)}\n`;
            }
            
            recibo += `========================\n`;
            recibo += `¬°Gracias por su compra! üòä`;
            
            alert(recibo);
        }

        function cancelarVenta() {
            if (ventaActual.length > 0 && confirm('¬øCancelar venta actual?')) {
                ventaActual = [];
                actualizarVistaVentaActual();
                mostrarAlerta('Venta cancelada');
            }
        }

        // Clientes
        function mostrarTodosClientes() {
            const container = document.getElementById('lista-clientes');
            
            if (clientes.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;">No hay clientes registrados</p>';
                return;
            }
            
            container.innerHTML = clientes.map(cliente => {
                const deudaClass = cliente.totalDeuda > 0 ? 'con-deuda' : '';
                const deudaInfo = cliente.totalDeuda > 0 ? 
                    `<span class="deuda-amount">Debe: ${cliente.totalDeuda.toFixed(2)}</span>` :
                    '<span style="color:#4CAF50;font-weight:bold;">Sin deuda</span>';
                
                return `
                    <div class="cliente-item ${deudaClass}">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <h4>${cliente.nombre}</h4>
                                <p style="color:#666;font-size:0.9rem;">${cliente.telefono || 'Sin tel√©fono'}</p>
                            </div>
                            <div style="text-align:right;">
                                ${deudaInfo}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function mostrarClientesDeuda() {
            const clientesConDeuda = clientes.filter(c => c.totalDeuda > 0);
            const container = document.getElementById('lista-clientes');
            
            if (clientesConDeuda.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;">No hay clientes con deuda</p>';
                return;
            }
            
            const totalDeuda = clientesConDeuda.reduce((sum, c) => sum + c.totalDeuda, 0);
            
            container.innerHTML = `
                <div style="background:#fff3cd;border:1px solid #ffeaa7;color:#856404;padding:15px;border-radius:8px;margin-bottom:20px;text-align:center;">
                    <strong>üí∞ Total por cobrar: ${totalDeuda.toFixed(2)}</strong>
                </div>
            ` + clientesConDeuda.map(cliente => `
                <div class="cliente-item con-deuda">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <div>
                            <h4>${cliente.nombre}</h4>
                            <p style="color:#666;font-size:0.9rem;">${cliente.telefono || 'Sin tel√©fono'}</p>
                        </div>
                        <div style="text-align:right;">
                            <span class="deuda-amount">${cliente.totalDeuda.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function abrirPagoDeuda() {
            const clientesConDeuda = clientes.filter(c => c.totalDeuda > 0);
            
            if (clientesConDeuda.length === 0) {
                mostrarAlerta('No hay clientes con deuda', 'error');
                return;
            }
            
            const contenido = document.getElementById('contenido-pago-deuda');
            contenido.innerHTML = `
                <div class="form-group">
                    <label>Seleccionar Cliente:</label>
                    <select id="clienteSeleccionado" onchange="mostrarDetalleCliente()">
                        <option value="">-- Seleccionar cliente --</option>
                        ${clientesConDeuda.map(c => 
                            `<option value="${c.id}">${c.nombre} - Debe: ${c.totalDeuda.toFixed(2)}</option>`
                        ).join('')}
                    </select>
                </div>
                
                <div id="detalle-cliente" class="hidden">
                    <div class="form-group">
                        <label>Monto a pagar:</label>
                        <input type="number" id="montoPago" step="0.50" placeholder="0.00">
                    </div>
                    
                    <div class="form-group">
                        <button class="btn btn-primary" onclick="procesarPagoDeuda()">‚úÖ Procesar Pago</button>
                    </div>
                </div>
            `;
            
            mostrarModal('modalPagoDeuda');
        }

        function mostrarDetalleCliente() {
            const clienteId = document.getElementById('clienteSeleccionado').value;
            const detalle = document.getElementById('detalle-cliente');
            
            if (clienteId) {
                const cliente = clientes.find(c => c.id === clienteId);
                document.getElementById('montoPago').max = cliente.totalDeuda;
                document.getElementById('montoPago').value = cliente.totalDeuda.toFixed(2);
                detalle.classList.remove('hidden');
            } else {
                detalle.classList.add('hidden');
            }
        }

        function procesarPagoDeuda() {
            const clienteId = document.getElementById('clienteSeleccionado').value;
            const montoPago = parseFloat(document.getElementById('montoPago').value);
            
            if (!clienteId || !montoPago) {
                mostrarAlerta('Seleccione cliente y monto', 'error');
                return;
            }
            
            const cliente = clientes.find(c => c.id === clienteId);
            
            if (montoPago > cliente.totalDeuda) {
                mostrarAlerta('El monto excede la deuda', 'error');
                return;
            }
            
            // Registrar pago
            const pago = {
                id: generarId(),
                clienteId: clienteId,
                clienteNombre: cliente.nombre,
                monto: montoPago,
                fecha: new Date().toISOString()
            };
            
            pagosDeuda.push(pago);
            cliente.totalDeuda -= montoPago;
            
            // Marcar ventas como pagadas si ya no hay deuda
            if (cliente.totalDeuda === 0) {
                ventas.filter(v => v.cliente && v.cliente.id === clienteId && !v.pagada)
                      .forEach(v => v.pagada = true);
            }
            
            guardarDatos();
            cerrarModal('modalPagoDeuda');
            
            mostrarAlerta(`Pago de ${montoPago.toFixed(2)} procesado para ${cliente.nombre}`);
            
            // Mostrar recibo de pago
            let recibo = `üßæ RECIBO DE PAGO\n`;
            recibo += `Pan y Atoles\n`;
            recibo += `========================\n`;
            recibo += `Fecha: ${new Date().toLocaleString('es-MX')}\n`;
            recibo += `Cliente: ${cliente.nombre}\n`;
            recibo += `Monto pagado: ${montoPago.toFixed(2)}\n`;
            recibo += `Deuda restante: ${cliente.totalDeuda.toFixed(2)}\n`;
            recibo += `========================\n`;
            recibo += `¬°Gracias por su pago! üòä`;
            
            alert(recibo);
        }

        // Reportes
        function actualizarEstadisticas() {
            const container = document.getElementById('estadisticas-generales');
            
            const totalVentas = ventas.length;
            const ventasContado = ventas.filter(v => v.tipoPago === 'contado').length;
            const ventasFiado = ventas.filter(v => v.tipoPago === 'fiado').length;
            
            const ingresoTotal = ventas.reduce((sum, v) => sum + v.total, 0);
            const ingresoContado = ventas.filter(v => v.tipoPago === 'contado').reduce((sum, v) => sum + v.total, 0);
            const ingresoFiado = ventas.filter(v => v.tipoPago === 'fiado').reduce((sum, v) => sum + v.total, 0);
            
            const totalDeuda = clientes.reduce((sum, c) => sum + c.totalDeuda, 0);
            const totalPagos = pagosDeuda.reduce((sum, p) => sum + p.monto, 0);
            
            container.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalVentas}</div>
                    <div class="stat-label">Ventas Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${ingresoTotal.toFixed(0)}</div>
                    <div class="stat-label">Ingresos Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${ingresoContado.toFixed(0)}</div>
                    <div class="stat-label">Efectivo (${ventasContado})</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalDeuda.toFixed(0)}</div>
                    <div class="stat-label">Por Cobrar (${ventasFiado})</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalPagos.toFixed(0)}</div>
                    <div class="stat-label">Pagos Recibidos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${clientes.length}</div>
                    <div class="stat-label">Clientes</div>
                </div>
            `;
        }

        function mostrarReporteVentas() {
            const container = document.getElementById('contenido-reportes');
            
            if (ventas.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;">No hay ventas registradas</p>';
                return;
            }
            
            const ventasHoy = ventas.filter(v => {
                const hoy = new Date().toDateString();
                const fechaVenta = new Date(v.fecha).toDateString();
                return hoy === fechaVenta;
            });
            
            container.innerHTML = `
                <h3>üìà Reporte de Ventas</h3>
                <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                    <h4>Resumen del d√≠a (${ventasHoy.length} ventas):</h4>
                    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;margin-top:10px;">
                        <div>üíµ Contado: ${ventasHoy.filter(v => v.tipoPago === 'contado').reduce((sum, v) => sum + v.total, 0).toFixed(2)}</div>
                        <div>üí≥ Fiado: ${ventasHoy.filter(v => v.tipoPago === 'fiado').reduce((sum, v) => sum + v.total, 0).toFixed(2)}</div>
                        <div>üí∞ Total: ${ventasHoy.reduce((sum, v) => sum + v.total, 0).toFixed(2)}</div>
                    </div>
                </div>
                
                <h4>Historial de Ventas:</h4>
                <div style="max-height:400px;overflow-y:auto;">
                    ${ventas.slice(-20).reverse().map(venta => {
                        const fecha = new Date(venta.fecha).toLocaleString('es-MX');
                        const tipoIcon = venta.tipoPago === 'contado' ? 'üíµ' : 'üí≥';
                        const clienteInfo = venta.cliente ? ` - ${venta.cliente.nombre}` : '';
                        
                        return `
                            <div style="background:#f8f9fa;padding:10px;margin-bottom:10px;border-radius:5px;border-left:4px solid ${venta.tipoPago === 'contado' ? '#4CAF50' : '#f44336'};">
                                <div style="display:flex;justify-content:space-between;">
                                    <span>${tipoIcon} ${fecha}${clienteInfo}</span>
                                    <span style="font-weight:bold;">${venta.total.toFixed(2)}</span>
                                </div>
                                <div style="font-size:0.9rem;color:#666;margin-top:5px;">
                                    ${venta.items.map(item => `${item.nombre} x${item.cantidad}`).join(', ')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function mostrarReporteFinanciero() {
            const container = document.getElementById('contenido-reportes');
            
            const totalIngresos = ventas.reduce((sum, v) => sum + v.total, 0);
            const efectivoReal = ventas.filter(v => v.tipoPago === 'contado').reduce((sum, v) => sum + v.total, 0);
            const totalFiado = ventas.filter(v => v.tipoPago === 'fiado').reduce((sum, v) => sum + v.total, 0);
            const totalDeuda = clientes.reduce((sum, c) => sum + c.totalDeuda, 0);
            const totalCobrado = pagosDeuda.reduce((sum, p) => sum + p.monto, 0);
            
            container.innerHTML = `
                <h3>üí∞ Reporte Financiero</h3>
                
                <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
                    <h4>Resumen General:</h4>
                    <div style="display:grid;gap:10px;margin-top:15px;">
                        <div style="display:flex;justify-content:space-between;padding:10px;background:white;border-radius:5px;">
                            <span>üí∞ Total Vendido:</span>
                            <span style="font-weight:bold;">${totalIngresos.toFixed(2)}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:10px;background:#d4edda;border-radius:5px;">
                            <span>üíµ Efectivo en Mano:</span>
                            <span style="font-weight:bold;color:#155724;">${efectivoReal.toFixed(2)}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:10px;background:#f8d7da;border-radius:5px;">
                            <span>üí≥ Dinero por Cobrar:</span>
                            <span style="font-weight:bold;color:#721c24;">${totalDeuda.toFixed(2)}</span>
                        </div>
                        <div style="display:flex;justify-content:space-between;padding:10px;background:#d1ecf1;border-radius:5px;">
                            <span>üí∏ Total Cobrado:</span>
                            <span style="font-weight:bold;color:#0c5460;">${totalCobrado.toFixed(2)}</span>
                        </div>
                    </div>
                </div>
                
                ${pagosDeuda.length > 0 ? `
                    <h4>Historial de Cobros:</h4>
                    <div style="max-height:300px;overflow-y:auto;">
                        ${pagosDeuda.slice(-10).reverse().map(pago => `
                            <div style="background:#f8f9fa;padding:10px;margin-bottom:10px;border-radius:5px;border-left:4px solid #17a2b8;">
                                <div style="display:flex;justify-content:space-between;">
                                    <span>${pago.clienteNombre}</span>
                                    <span style="font-weight:bold;">${pago.monto.toFixed(2)}</span>
                                </div>
                                <div style="font-size:0.9rem;color:#666;">
                                    ${new Date(pago.fecha).toLocaleString('es-MX')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;
        }

        // Configuraci√≥n
        function nuevoDia() {
            if (confirm('¬øComenzar nuevo d√≠a? Solo se limpiar√° el inventario.')) {
                productos = [];
                ventaActual = [];
                guardarDatos();
                actualizarVistaProductos();
                actualizarProductosVenta();
                mostrarAlerta('¬°Nuevo d√≠a iniciado! Los clientes y ventas se mantienen.');
            }
        }

        function exportarDatos() {
            const datos = {
                productos,
                clientes,
                ventas,
                pagosDeuda,
                fechaExportacion: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(datos, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pos_pan_atoles_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            mostrarAlerta('Datos exportados exitosamente');
        }

        function resetearTodo() {
            if (confirm('‚ö†Ô∏è ¬øRESETEAR TODO? Esta acci√≥n eliminar√° TODOS los datos permanentemente.')) {
                if (confirm('Esta acci√≥n NO se puede deshacer. ¬øContinuar?')) {
                    localStorage.clear();
                    productos = [];
                    clientes = [];
                    ventas = [];
                    pagosDeuda = [];
                    ventaActual = [];
                    
                    actualizarVistaProductos();
                    actualizarProductosVenta();
                    actualizarEstadisticas();
                    
                    mostrarAlerta('Sistema reseteado completamente');
                }
            }
        }
    </script>
</body>
</html>